# Aurora BACK Project - Instrucciones para Claude Code

## ğŸ¯ CONTEXTO DEL FRAMEWORK

Aurora es un meta-framework que genera aplicaciones NestJS (back) y Angular (front)
desde definiciones YAML. Implementa:
- Arquitectura Hexagonal (Puertos y Adaptadores)
- CQRS (Command Query Responsibility Segregation)
- Criteria Pattern para consultas complejas
- Sistema de hash para tracking de cambios

## â›” REGLAS ABSOLUTAS

### NUNCA modificar directamente:
1. Ficheros YAML de definiciÃ³n (`*.aurora.yaml`) - Son la fuente de verdad
2. Entidades en `domain/` - Se regeneran desde YAML
3. Value Objects generados - Se regeneran desde YAML
4. Controladores REST en `@api/` - Se regeneran desde YAML
5. Resolvers GraphQL en `@api/` - Se regeneran desde YAML
6. Interfaces TypeScript generadas desde YAML

### SÃ puedo modificar:
1. **Handlers CQRS** - SOLO el cuerpo del mÃ©todo `execute()`
2. **Servicios custom** - Crearlos en carpetas designadas
3. **Tests** - Siempre puedo crear/modificar tests
4. **Ficheros de configuraciÃ³n** - .env, docker-compose, etc.

## ğŸ“ BACK STRUCTURE (NestJS)

All these folders and files are generated by Aurora
```
src/
â”œâ”€â”€ @api/[package]/
â”‚   â”œâ”€â”€ [module]/
â”‚   â”‚   â”œâ”€â”€ controllers/        # REST Controllers, entry point of the REST API
â”‚   â”‚   â”œâ”€â”€ dto/                # DTOs used by controllers and documentation generated in OpenAPI format through decorators
â”‚   â”‚   â”œâ”€â”€ graphql/            # Definition of types, inputs, queries, and mutations for the GraphQL API
â”‚   â”‚   â”œâ”€â”€ handlers/           # Service where both the REST API and GraphQL converge, containing the logic to be applied to the case covered by the API
â”‚   â”‚   â”œâ”€â”€ resolvers/          # Graphql Resolvers, entry point of the GraphQL API
â”‚   â”‚   â”œâ”€â”€ seeder/             # Service to populate the generated table with mock data for e2e testing
â”‚   â”‚   â””â”€â”€ index.ts            # Exporting and grouping controllers, handlers, resolvers, and additional services
â”‚   â”œâ”€â”€ [module].module.ts      # Declaration of controllers, handlers, resolvers, and additional services for NestJs Framework
â”‚   â””â”€â”€ [module].seeder.ts      # Service that defines the package name and permissions, if required, when the application starts up
â”‚
â”œâ”€â”€ @app/[package]/
â”‚   â”œâ”€â”€ [module]/
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ count/
â”‚   â”‚   â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”‚   â”œâ”€â”€ delete/
â”‚   â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”‚   â”œâ”€â”€ find/
â”‚   â”‚   â”‚   â”œâ”€â”€ get/
â”‚   â”‚   â”‚   â”œâ”€â”€ max/
â”‚   â”‚   â”‚   â”œâ”€â”€ min/
â”‚   â”‚   â”‚   â”œâ”€â”€ paginate/
â”‚   â”‚   â”‚   â”œâ”€â”€ raw-sql/
â”‚   â”‚   â”‚   â”œâ”€â”€ sagas/
â”‚   â”‚   â”‚   â”œâ”€â”€ sum/
â”‚   â”‚   â”‚   â”œâ”€â”€ update/
â”‚   â”‚   â”‚   â””â”€â”€ upsert/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ [package].seed.ts
â”‚   â”œâ”€â”€ [package].types.ts
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ public-api.ts
â”‚
â”œâ”€â”€ @aurora/                            # Folder containing base and reusable files for the Aurora structure
â”‚   â”œâ”€â”€ decorators/                     # Decorator container folder; THIS FOLDER AND CONTENTS MUST NOT BE MODIFIED
â”‚   â”‚   â”œâ”€â”€ auth.decorator.ts           # Combines the Permissions decorator with UseGuards, used in RestFULL and GraphQL APIs
â”‚   â”‚   â”œâ”€â”€ gql-headers.decorator.ts    # Get headers at an API GraphQL entry point
â”‚   â”‚   â”œâ”€â”€ gql-request.decorator.ts    # Get request at an API GraphQL entry point
â”‚   â”‚   â”œâ”€â”€ index.ts                    # file to export decorators barrels
â”‚   â”‚   â””â”€â”€ public-api.ts               # Barrels for decorators folder
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                        # Modules container folder; THIS FOLDER AND CONTENTS MUST NOT BE MODIFIED
â”‚   â”‚   â”œâ”€â”€ cqrs/                       #
â”‚   â”‚   â”œâ”€â”€ graphql/                    #
â”‚   â”‚   â”œâ”€â”€ lang/                       #
â”‚   â”‚   â”œâ”€â”€ mailer/                     #
â”‚   â”‚   â”œâ”€â”€ root/                       #
â”‚   â”‚   â”œâ”€â”€ sentry/                     #
â”‚   â”‚   â”œâ”€â”€ server-static/              #
â”‚   â”‚   â”œâ”€â”€ index.ts                    # file to export modules barrels
â”‚   â”‚   â””â”€â”€ public-api.ts               # Barrels for modules folder
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                       # Services container folder; THIS FOLDER AND CONTENTS MUST NOT BE MODIFIED
â”‚   â”‚   â”œâ”€â”€ bootstrap.service.ts        #
â”‚   â”‚   â”œâ”€â”€ index.ts                    # file to export services barrels
â”‚   â”‚   â”œâ”€â”€ logger.service.ts           #
â”‚   â”‚   â””â”€â”€ public-api.ts               #
â”‚   â”‚
â”‚   â”œâ”€â”€ core.module.ts
â”‚   â””â”€â”€ shared.module.ts
â”‚
â”œâ”€â”€ @config/
â”‚   â”œâ”€â”€ mailer/                         #
â”‚   â”‚   â”œâ”€â”€ index.ts                    # file to export modules barrels
â”‚   â”‚   â”œâ”€â”€ mailer-transport.module.ts  #
â”‚   â”‚   â””â”€â”€ public-api.ts               # Barrels for modules folder
â”‚   â”œâ”€â”€ index.ts                    # file to export decorators barrels
â”‚   â””â”€â”€ public-api.ts               # Barrels for decorators folder
â”‚
â”œâ”€â”€ assets/
â”œâ”€â”€ i18n
â”œâ”€â”€ app.controller.spec.ts
â”œâ”€â”€ app.controller.ts
â”œâ”€â”€ app.module.ts
â”œâ”€â”€ app.queues.ts
â”œâ”€â”€ app.service.ts              # example service with a hello world
â”œâ”€â”€ index.ts                    # file for sharing classes from the application, normally empty
â”œâ”€â”€ main.ts                     # entry point of the nestjs application
â””â”€â”€ repl.ts                     # file to start nestjs in REPL mode
```

## ğŸ”§ COMANDOS AURORA CLI
```bash
# Create clean project
aurora new back my-app

# Generate module from YAML
aurora load back module -n=library/book

# Regenerate with changes (respects hash of modified files)
# -f force overwrite if file exists
# -t generate the tests
aurora load back module -n=library/book -ft

# Add preconfigured packages
aurora add back auditing
aurora add back oauth
aurora add front settings
```

## ğŸ“‹ YAML REFERENCE (Schema v1.2)

Tipos de propiedades disponibles:
- BÃ¡sicos: `id`, `varchar`, `text`, `int`, `bigint`, `smallint`, `float`, `decimal`, `boolean`, `date`, `timestamp`
- Especiales: `enum`, `json`, `jsonb`, `password`, `blob`
- Relaciones: `relationship`, `manyToMany`

Ejemplo de relaciÃ³n many-to-one:
```yaml
- name: authorId
  type: id
  relationship:
    type: many-to-one
    aggregateName: LibraryAuthor
    modulePath: library/author
    key: id
    field: author
```

## ğŸ¯ CRITERIOS PARA CLAUDE CODE

### Cuando el usuario pida nueva funcionalidad:

1. **Â¿Es estructural (nuevo campo, nueva entidad)?**
   â†’ Responder: "Esto requiere modificar el YAML y ejecutar Aurora CLI"
   â†’ Mostrar cÃ³mo deberÃ­a verse el YAML
   â†’ NO generar cÃ³digo manualmente

2. **Â¿Es lÃ³gica de negocio?**
   â†’ Implementar en el handler correspondiente
   â†’ Crear servicios auxiliares en carpeta `services/`

### PatrÃ³n de implementaciÃ³n de lÃ³gica custom:
```typescript
// En: @core/library/book/application/commands/create-book.command-handler.ts

@CommandHandler(CreateBookCommand)
export class CreateBookCommandHandler implements ICommandHandler<CreateBookCommand> {
    constructor(
        private readonly repository: BookRepository,
        private readonly isbnValidator: IsbnValidatorService,  // Servicio custom
    ) {}

    async execute(command: CreateBookCommand): Promise<void> {
        // âœ… ZONA EDITABLE - AÃ±adir lÃ³gica aquÃ­

        // ValidaciÃ³n custom
        await this.isbnValidator.validate(command.payload.isbn);

        // LÃ³gica de negocio especÃ­fica
        if (command.payload.publishDate > new Date()) {
            throw new BookPublishDateException();
        }

        // El resto es estÃ¡ndar Aurora
        const book = Book.register(command.payload);
        await this.repository.create(book);
    }
}
```

## ğŸ” CRITERIA PATTERN (QueryStatement)

Aurora usa QueryStatement para consultas complejas:
```typescript
const queryStatement: QueryStatement = {
    where: {
        // Operadores disponibles
        title: { contains: 'TypeScript' },      // LIKE %value%
        price: { gte: 10, lte: 50 },            // >= 10 AND <= 50
        status: { in: ['PUBLISHED', 'DRAFT'] }, // IN (...)
        authorId: { eq: 'uuid-here' },          // =
        deletedAt: { isNull: true },            // IS NULL
    },
    include: {
        author: true,           // Eager loading de relaciones
        categories: true,
    },
    order: [
        { createdAt: 'desc' },
    ],
    offset: 0,
    limit: 25,
};
```

## âš ï¸ ANTES DE CUALQUIER MODIFICACIÃ“N

1. Verificar si el fichero es generado o custom
2. Si es generado â†’ buscar la zona editable o crear fichero custom
3. Si dudo â†’ preguntar al usuario
4. NUNCA asumir que puedo modificar estructura